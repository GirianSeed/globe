[SCE CONFIDENTIAL DOCUMENT]
"PlayStation 2" Programmer Tool Runtime Library Release 2.5.3
                  Copyright (C) 2002 Sony Computer Entertainment Inc.
                                                     All Rights Reserved



ＡＴＯＫライブラリを使用した、ソフトウェアキーボードプログラムサンプル


< ライブラリとの依存関係 >
- ライブラリとの依存関係の構成は、以下のようになっています。


     |                                                      |
     +---------------------------------------------+        |
     |  skb.a                                      |        |
     |                                             |        |
     |                                             |        |
     +------------------------------------------------------+
     |  libfep.a    + libsoftkb.a + skbres.a | fontwrap.a   |
     |              |         +---+          |              |
     |              |         |              |              |
     +------------------------------------------------------+
     | libatok.a    |libccc.a |              | libpfont.a   | 
     +------------------------+              +--------------+

  libfep.a が、libatokを直接操作しているサンプルプログラムです。
  ソースファイルは、fep/ フォルダ以下にあります。

  他は、ATOKを、グラフィカルに操作するためのソフトウェアキーボードの
  サンプルプログラムです。



< ファイル構成 >

	Makefile   ： メイクファイル 以下のライブラリを作成します。
	fontwrap   ： fontwrap.a  libpfont関連プログラム
	resouce    ： skbres.a    ソフトウェアキーボードリソースデータ
	fep        ： libfep.a    ソフトウェアキーボードATOK関連プログラム
	libsoftkb  ： libsoftkb.a ソフトウェアキーボード動作関連プログラム
	skb        ： skb.a       ソフトウェアキーボード制御プログラム


	-+---- fontwrap
	 |      +---- fontwrap.c  : libpfontラッパ関数
	 |      +---- fontwrap.h  :
	 | 
	 +---- resource
	 |      +---- key キーレイアウトファイル
	 |      |      +---- jp
	 |      |      |      +---- abc.bin     : ABC配列
	 |      |      |      +---- aiuHira.bin : あいうえおひらがな配列
	 |      |      |      +---- aiuKana.bin : アイウエオかたかな配列
	 |      |      |      +---- kigo.bin    : 文字一覧配列
	 |      |      |      +---- num.bin     : 数字配列
	 |      |      |      +---- qwerty.bin  : QWERTY（PC風）配列
	 |      |      +---- other
	 |      |             +---- dutchQ.bin   : オランダPC風配列
	 |      |             +---- cfrenchQ.bin : カナディアンフレンチPC風配列
	 |      |             +---- frenchQ.bin  : フランスPC風配列
	 |      |             +---- germanQ.bin  : ドイツPC風配列
	 |      |             +---- idiomChr.bin : 発音記号つき文字一覧配列
	 |      |             +---- italianQ.bin : イタリアPC風配列
	 |      |             +---- numF.bin     : 数字配列
	 |      |             +---- portugQ.bin  : ポルトガルPC風配列
	 |      |             +---- spanishQ.bin : スペインPC風配列
	 |      |             +---- spSign.bin   : 記号一覧配列
	 |      |             +---- ukQ.bin      : イギリスPC風配列
	 |      |             +---- usQ.bin      : アメリカPC風配列
	 |      +---- tex テクスチャファイル
	 |            +---- help ヘルプ関連
	 |            |      +---- skbHEng.tm2  : 英語
	 |            |      +---- skbHJp.tm2   : 日本語
	 |            |      +---- skbHFch.tm2  : フランス語
	 |            |      +---- skbHSp.tm2   : スペイン語
	 |            |      +---- skbHIta.tm2  : イタリア語
	 |            |      +---- skbHDch.tm2  : オランダ語
	 |            |      +---- skbHPtg.tm2  : ポルトガル語
	 |            |      +---- skbHGmn.tm2  : ドイツ語
	 |            |      +---- skbHItem.tm2 : コントローラ等
	 |            +---- skb ソフトウェアキーボード
	 |                   |
	 |                   +---- skbKey.tm2   : キートップの文字
	 |                   +---- skbBG.tm2    : キーボード土台
	 |                   +---- fepbar.tm2   : FEPの状態
	 |                   |                    (USBキーボードで使用)
	 |                   +---- tField.tm2   : テキストフィールド
	 |                   +---- skbMdbar.tm2 : モードバー（ソフトウェア
	 |                   |                    キーボードで使用）
	 |                   +---- skbBtn.tm2   : キーのボタン、カーソル等
	 | 
	 +---- fep
	 |      +---- atok.inc   : ATOK  キーバインド定義ファイル
	 |      +---- ime.inc    : IME風 キーバインド定義ファイル
	 |      +---- fepskb.inc : ソフトウェアキーボード用定義ファイル
	 |      +---- fepkey.c   : USBキーボードからの入力を処理するルーチン
	 |      +---- fepskb.c   : ソフトウェアキーボードからの入力を処理する
	 |      |                  ルーチン
	 |      +---- libfep.c   : ATOKを使用するためのルーチン
	 |      +---- libfep.h   : 同上定義ファイル
	 |      +---- mtfifo.c   : FIFO
	 |      +---- mtfifo.h   : 同上定義ファイル
	 |      +---- util.c     : ユーティリティルーチン
	 |                         (ひらがな->半角カタカナ etc)
	 +---- libsoftkb
	 |      +---- help.inc    : ヘルプ定義ファイル
	 |      +---- modebar.inc : モードバー定義ファイル
	 |      +---- libsoftkb.c :ソフトウェアキーボードインターフェスルーチン
	 |      +---- libsoftkb.h : 同上定義ファイル
	 |      +---- sharedskb.h : ソフトウェアキーボード内部定義
	 |      +---- skb_core.c  : ソフトウェアキーボードコア関数群
	 |      +---- skb_list.c  : ソフトウェアキーボードリスト(一覧)関数群
	 | 
	 +---- skb
	 |      +---- skb.c       : ソフトウェアキーボード制御サンプル
	 |      +---- draw.c      : パケット作成関数
	 |      +---- fepbar.c    : 入力モード表示関数
	 |      +---- fepbar.h    :
	 |      +---- fepbar.inc  : 入力モードテクスチャUV値など定義
	 |      +---- sysenv.c    : システム設定取得関数
	 |      +---- sysenv.h    :
	 |      +---- textField.c : テキストフィールド関数
	 |      +---- textField.h :
	 |      +---- tim2.c      : tim2操作ファイル
	 |      +---- tim2.h      :
	 |      +---- tim2wrap.c  : tim2.cラップ関数
	 |      +---- tim2wrap.h  :
	 | 
	 +---- include            : 作成ライブラリヘッダ格納フォルダ
	 |      +---- extypes.c   : 型拡張定義
	 |      +---- shareddef.h : ソフトウェアキーボード共通定義
	 | 
	 +---- lib     : 作成ライブラリ格納フォルダ


	< キートップ設定ファイル *.bin >
	- ファイルフォーマット
	  大きく分けて以下のようなデータ構造になります。

	+----------------------------------------+
	| ヘッダ                                 |
	+----------------------------------------+
	| --- スプライト                         |
	+----------------------------------------+
	| --- テクスチャ座標                     |
	+----------------------------------------+
	| --- 背景                               |
	+----------------------------------------+
	| --- キー配列                           |
	+----------------------------------------+

	<ヘッダ : 構造体 lump_t>
	ヘッダは、
		スプライト情報
		テクスチャUV情報
		背景情報
		キー配列情報
	へのファイルの先頭からのオフセットとサイズを持ちます。

	<スプライト : 構造体 sprite_t>
		スプライト定義の集まりです。

	<テクスチャ座標 : 構造体 uv_t>
		テクスチャ座標定義の集まりです。

	<背景 ： 背景構造体 >

	<キー配列 : 構造体 button_t>
		キー情報定義の集まりです。


< ライブラリ作成 >

	% make clean  : クリーン
	% make        : ライブラリ作成

	< Make 環境の変更について>

	 Makefie 内では 、以下の環境変数がそれぞれ設定されています。

	 ---------------------------------------------------------------------
	  RESOURCE_SOURCE = SKBRES_LINK        # ライブラリとしてリンク
	  RESOURCE_SOURCE = SKBRES_LOAD        # ファイルロード
	 ---------------------------------------------------------------------
	 - ソフトウェアキーボードで使用する、テクスチャやキー配列のデータを
	   読みこむか、リンクするかを選択できます。

	 ---------------------------------------------------------------------
	  CDBOOT = 0                            # 0;host 1: cdrom    
	 ---------------------------------------------------------------------
	 - CD ディスク、ホスト上のどちらからファイル読みこみを行なうかの
	   パス切り替えを選択できます。

	 ---------------------------------------------------------------------
	  LINK_RESOURCE = REGION_LINK_ALL      # 全て使用
	  LINK_RESOURCE = REGION_J_ONLY        # 日本版のリソースのみ有効
	  LINK_RESOURCE = REGION_J_OTHER_ONLY  # 海外版のリソースのみ有効
	 ---------------------------------------------------------------------
	 - リンク、またはロードするリソースを選択できます。（いずれかを有効）
	   Makefile の引数で指定されていた場合そちらが有効になります。
	   また、リンクしていない、リソースを操作しようとした場合、
	   プログラムは正常に動作しませんので、注意してください。

	 ---------------------------------------------------------------------
	  LINK_ATOK = ATOK_LINK_USE           # ATOKライブラリを使用します。  
	  LINK_ATOK = ATOK_NOT_LINK           # ATOKライブラリを使用しません。
	 ---------------------------------------------------------------------
	 - ATOK ライブラリのリンクについての選択ができます。

	以上の、Makefile 内環境変数を変更した場合は、以下のコマンドを実行し
	ライブラリのリビルドを行なってください。

	% make define  : make clean 後、common.def ファイルが出力
	% make 


< 画面パーツ解説 >

     +--------------------------------------------------------+
     | textField                                              |
     +--------------------------------------------------------+
     | KBD                                       |    +--------+
     |                                           |    | fepbar |
     |                                           |    +--------+
     |                                           |
     |                                           |
     |                                           |
     |                                           | +----------+
     +-------------------------------------------+ | modebar  |
                                                   +----------+

	<テキストフィールド textField>
	ソフトウェアキーボード、USBキーボードから入力された文字を出力します。

	<入力モードバー fepbar>
	日本版 ： ATOKの入力モード表示 + ソフトウェアキーボード表示ボタン

	海外版 ： ソフトウェアキーボード表示ボタン

	<ソフトウェアキーボード使用時>
        入力モード一覧 + 現在選択中の入力モード

	<ソフトウェアキーボード KBD >
	プログラムを起動すると上記のようなテキストフィールドと
	ソフトウェアキーボードと入力モードバーが表示されます。
	注意：
	ユーザが使用した最後の設定がハードディスクドライブの
	__system/conf/system.iniを読んでいますので、設定によっては
	ソフトウェアキーボードが表示されない場合もあります。

	ソフトウェアキーボード入力時に USB キーボードのキーを押すと
	USB キーボードから入力されるとみなし、ソフトウェアキーボードは
	画面上から消えます。
	この時、再度ソフトウェアキーボードから入力したい場合は、
	入力モードバーの右側(日本版)にソフトウェアキーボード表示
	ボタンにカーソルが合っているので、コントローラ上の○ボタンを
	押すと、ソフトウェアキーボードが表示されます。


< 操作説明 >
	<ソフトウェアキーボード使用時>
	SELECTボタン   : 入力モード切替

	・日本語入力
	   ○ボタン : 文字入力/部分確定
	   △ボタン : スペース/変換
	   □ボタン : 削除
	   ×ボタン : キャンセル
	   ↑↓←→（方向キー）: 文字移動(文節移動、文節伸縮)
	   SELECTボタン: 入力モード切替(キートップ切替)
	   STARTボタン : 全部確定
	    L1ボタン : (なし)
	   L2ボタン : キャレット移動(左)
	   R1ボタン : シフト
	   R2ボタン : キャレット移動(右)

	・変換中
	   ○ボタン : 確定
	   ×ボタン : 入力に戻る
	   △ボタン : 変換候補表示
	   ←→ （方向キー）   : 文節の移動（注目文節の変更）
	   R1+←→ （方向キー）: 文節の拡張と縮小
	  
	・候補選択中
	   ○ボタン : 確定
	   ×ボタン : 入力に戻る
	   △ボタン : 次候補
	   ↑↓ （方向キー）:候補選択。
	   ←→ （方向キー）:候補選択し、文節移動。


	・直接入力
	   ○ボタン : 文字入力
	   △ボタン : スペース
	   □ボタン : 削除
	   ×ボタン : キャンセル
	   ↑↓←→（方向キー）: 文字移動
	   STARTボタン  : 確定
	   L1ボタン : (なし)
	   L2ボタン : キャレット移動(左)
	   R1ボタン : シフト
	   R2ボタン : キャレット移動(右)

	<USBキーボード使用時>
	   ○ボタン : ソフトウェアキーボード表示
	   USBキーボード 入力。

	< 入力モード切替 >
	  F12 または SELECTボタン押下により、
		ひらがな入力                [あ](青) ATOK/ON
		全角カタカナ入力            [ア](青) ATOK/ON
		半角カタカナ入力            [_ｱ](青) ATOK/ON
		全角アルファベット入力      [Ａ](青) ATOK/ON
		半角アルファベット入力      [_A](青) ATOK/ON
		直接入力                    [_A]     ATOK/OFF
		ひらがな固定入力            [あ]     ATOK/ON
		全角カタカナ固定入力        [ア]     ATOK/ON
		半角カタカナ固定入力        [_ｱ]     ATOK/ON
		全角アルファベット固定入力  [Ａ]     ATOK/ON
		半角アルファベット固定入力  [_A]     ATOK/ON

	  というように使用モードにより fepbar 表示が遷移します。
	  通常の[半角/全角]により漢字入力/直接入力(トグル)モード
	  になります。

	 < キーバインド >
	  システムの設定によります。
	  この値は、使用された最後の状態が保存されます。
	  設定1 : IME風  (デフォルト)
	  設定2 : ATOK風 

	 < アルファベット入力、かな入力 >
	  システムの設定によります。
	  この値は、使用された最後の状態が保存されます。

	 < AltGr ヨーロッパ系キーボード >
	  通常ヨーロッパ系のキーボードでは、右側Altキーが
	  AltGrキーに置き換わっています。



< プログラムの流れ >

入力情報から、文字コード入力、Atokコマンド操作を行い、
ＡＴＯＫから状態を取得し、表示しています。


 +-----------+  +-----------+ 
 | libpad.a  |  |libusbkb.a | 
 +----+------+  +-----+-----+ 
 |   pad.c   |  |   kbd.c   | 
 +-----------+  +-----------+ 
      |               |  
      |---------------+     文字コード変換
 +------------+             +------------+
 |   main.c   |-----+---<>--|  libccc.a  |
 +------------+     |       +------------+
      |      +------+                
skb/  |      |        テキストＢＯＸ    /fontwrap      文字列を表示。      
 +------------+    +---------------+  +--------------++--------------+                     
 |  skb.c     |----|  textField    |--|  fontwrap.c  ||  libpfont.a  | 
 +------------+    +---------------+  +--------------++--------------+                     
  | | | 
  | | | テキストフィールド、ソフトウェアキーボード、FEPの実装。
  | | | パッドからのメッセージをソフトウェアキーボードに投げる。
  | | | USBキーボードのメッセージは、直接FEPに送られる
  | | | 
  | | |                      +===============================================+
  | | | コントローラ情報 ->  #    libsoftkb/           画面キーボード入力    #
  | | +----------------------+-->--+-------------+      +--------------+     #
  | |                        #     |             |--<>--|  skb_core.c  |     #
  | V USBキーボード入力      #     |             |      +--------------+     #
  | |                        #     | libsoftkb.c |--<>--|  skb_list.c  |     #
  | |   +--------------------+--<--|             |      +--------------+     #
  | |   | <- 文字コード      #     +-------------+       文字一覧入力        #
  | |   |    & 制御コード    #                                               #
  | |   |                    #                      +========================+
  | |   |                    #                      #
  | V +=V====================+ キーコードを解釈して #  +=====================+
  | | # |  fep/                ATOKのコマンドに変換 #  #  ATOKライブラリ     #
  | | # | +----------+        +----------------+    #  #  +------------+     #
  | | # +-+          |---<>---|    fepkey.c    |-->-+--+--| libatok.a  |     #
  | +-+---+  fep.c   |        +----------------+    #  #  |            |     #
  |   #   |          |---<>---|    fepskb.c    |-->-+--+--|            |     #
  +-- +---|          |        +----------------+    #  #  |            |     #
      #   |          |---<-----------------------------+--|            |     #
      #   +----------+     <<確定文字列/変換文字列  #  #  +------------+     #
      #   ・ATOK/ONの時は、FEPからfepkey.c          #  +========|============+
      #    fepskb.cを介してlibatok.aに              #           |       
      #    確定済み文字列が送られる。               #           X       
      #    この場合キーバインドがアタッチされます。 #           | HDDアクセス
      #   ・ATOK/OFFの時は、FEPから直接skb.cに      #    +-------------+
      #     確定済み文字列が送られる。              #    |   pfs.irx   |
      +=============================================+    +-------------+




< 外部インターフェース >

	コンパイラオプション -I$ 検索パスに以下の設定を行ないます。

	    utf8/libccc/include
	    libpfont/include
	    include 

	    lib/*.a を、リンクします。

	また、以下のファイルをインクルードします。
	    #include <sys/types.h>
	    #include <eetypes.h>

	    #include <libccc.h>
	    #include <libpfont.h>
	    #include <libfep.h>
	    #include <libsoftkb.h>
	    #include <skb.h>


	< ソフトウェアキーボード制御サンプル 使用手順 >

	  Init_SKBConfig(SKB_ARG*arg, char *fsName, short keyType, 
	  short repWait, short repSpeed ); // 環境初期化
	    ↓
	  SKB_Init(void);     // ソフトウェアキーボード初期化
	    ↓
	  SKB_SetInhibit_MaskChar( u_int (*ucs4)[10], int count );     
		   // 入力禁止文字でもキーボード入力可の文字の登録(゛゜など)
	  SKB_SetInhibit_Enable( u_int (*ucs4)[10], int count );       
		   // 入力禁止文字の登録
	    ↓
	  SKB_Open( KEYBOARD_SET* kbSet, u_int editType, u_int* usc4 ); 
		 // ソフトウェアキーボードオープン
	    ↑     ↓
	    ↑   SKB_SetUsbKeyborad( int kbStat, USBKBDATA_t* ,int numLock ); 
		 // usbキー情報取得
	    ↑     ↓
	    ↑   SKB_Control( u_long ulPad );                                 
		 // padを渡して、制御
	    ↑     ↓
	    ↑   SKB_MakeVif1CallPacket( int clipOffX, int clipOffY );
		 // 描画パケット作成
	    ↑     ↓
	    SKB_Close( char* );                                           
	    // ソフトウェアキーボードクローズ
	       ↓
	  SKB_Exit(void);      // ソフトウェアキーボードの終了



< 備考 >
  システム設定の詳細は以下の通りです。

	< システムソフトウェア システム設定 >
	<キーボード>
	・キーボードタイプ(DEF= 英語キーボード)
		日本語キーボード <--> 英語キーボード

	・リピート開始までの時間(DEF= 標準)
		短い <--> 標準 <--> 長い

	・キーリピートの速さ(DEF= 標準)
		遅い <--> 標準 <--> 速い

	<マウス>
	・マウス(DEF= 右利き用)
		右利き <--> 左利き

	・マウスカーソルの速さ(DEF= 標準)
		遅い <--> 標準 <--> 速い

	<日本語入力>
	・日本語入力(DEF= ローマ字入力)
		ローマ字入力 <--> カナ入力

	・キーバインド(DEF= 設定1)
		設定1 <--> 設定2

	<SOFTKB> ※ユーザの操作により状態が保存されます。
		   このサンプルでは、保存作業はしていません。
	・ソフトウェアキーボードON/OFF(DEF= ON)
		ON <--> OFF
		(software keyboard use <--> USB keyboard use)

	・アルファベット配列キーボードの種類(DEF= QWERTY)
		ABC配列 <--> QWERTY


< 文字コードについて >
	・ATOK                    SJIS
	・FEP                     UCS2(型はu_int)
	・ソフトウェアキーボード  UCS2(型はu_int)
	・テキストフィールド      UCS2(型はu_int)
	・FONT                    UTF8

< 注意事項 >
	- このプログラムでは、ソース内に Shift JIS の文字列を含んで
	  いるため、環境変数 LANG の影響を受ける場合がありますので
	  ご注意ください。

	  このプログラムを使用される際は、環境変数 LANG に Shift JIS を
	  指定してください。

	 .bashrc の場合： 
	 $ export LANG=C-SJIS

	 .cshrc の場合：
	 $ setenv LANG C-SJIS


